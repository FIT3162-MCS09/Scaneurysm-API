name: Deploy to AWS Lambda with Zappa

on:
  workflow_dispatch:

env:
  AWS_REGION: ap-southeast-1

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        # Install Zappa and its dependencies
        pip install zappa==0.54.0 boto3==1.26.137 s3transfer==0.6.1
        # Install project dependencies
        pip install -r requirements.txt
        # Verify installations
        echo "Python version:"
        python --version
        echo "Pip version:"
        pip --version
        echo "Installed packages:"
        pip list | grep zappa

    - name: Check if Lambda exists
      id: check_lambda
      run: |
        EXISTS=$(aws lambda list-functions --query "Functions[?FunctionName=='mcs09-production'].FunctionName" --output text)
        if [ -n "$EXISTS" ]; then
          echo "Lambda function exists, will update"
          echo "exists=true" >> $GITHUB_OUTPUT
        else
          echo "Lambda function does not exist, will deploy new"
          echo "exists=false" >> $GITHUB_OUTPUT
        fi

    - name: Deploy or Update with Zappa
      env:
        ENDPOINT: ${{ secrets.DB_ENDPOINT }}
        USER: ${{ secrets.DB_USERNAME }}
        PASS: ${{ secrets.DB_PASSWORD }}
      run: |
        # Check if bucket exists first, silently
        if ! aws s3api head-bucket --bucket zappa-mcs09-deployment 2>/dev/null; then
          echo "Creating S3 bucket..."
          aws s3api create-bucket \
            --bucket zappa-mcs09-deployment \
            --region ap-southeast-1 \
            --create-bucket-configuration LocationConstraint=ap-southeast-1
        else
          echo "S3 bucket already exists, continuing..."
        fi
        
        # Ensure we're in the correct directory
        cd $GITHUB_WORKSPACE
        
        # Debug: Show current directory and contents
        pwd
        ls -la
        
        if [ "${{ steps.check_lambda.outputs.exists }}" == "true" ]; then
          echo "Updating existing Lambda function..."
          python -m zappa update production
        else
          echo "Deploying new Lambda function..."
          python -m zappa deploy production
        fi
        
        echo "Deployment completed. Checking status..."
        python -m zappa status production

    - name: Debug Zappa Installation
      if: failure()
      run: |
        echo "Python path:"
        which python
        echo "Python version:"
        python --version
        echo "Site packages location:"
        python -c "import site; print(site.getsitepackages())"
        echo "Zappa location:"
        python -c "import zappa; print(zappa.__file__)"
        echo "Current directory:"
        pwd
        echo "Directory contents:"
        ls -la
        echo "Python path:"
        python -c "import sys; print('\n'.join(sys.path))"